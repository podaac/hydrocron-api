# This is the main build pipeline that verifies and publishes the software
name: Build
# Controls when the workflow will run
on:
  # Triggers the workflow on push events
  push:
    branches: 
    - main 
    - develop
    - 'release/**'
    - 'feature/**' 
    - 'issue/**' 
    - 'issues/**' 
    - 'dependabot/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PROJECT_ NAME: podaac/hydrocron-api

jobs:
  # First job in the workflow installs and verifies the software
  build:
    name: Build, Test, Deploy
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    steps:
      # Checkout
      - name: Checkout project to build and deploy
        uses: actions/checkout@v2

      ## Read the json file into the environment variables
      - name: JSON to variables
        uses: actions/checkout@v2
        with:
          filename: 'package.json'
          prefix: project

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install pytest pytest-cov
          pip3 install -r requirements.txt

      - name: Setup local DynamoDB
        run: docker run -d -p 8000:8000 amazon/dynamodb-local

      - name: Load sample
        run: python3 tests/example_load_data.py

      - name: Test with pytest
        run: pytest tests/test_api.py